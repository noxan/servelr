#!/usr/bin/env node

'use strict';
var program = require('commander');
var connect = require('connect');
var connectLivereload = require('connect-livereload');
var serveStatic = require('serve-static');
var tinylr = require('tiny-lr');
var watch = require('node-watch');
var chalk = require('chalk');
var resolve = require('path').resolve;


program
  .version(require('../package.json').version)
  .option('-p, --port <port>', 'specify the port [3000]', Number, 3000)
  .option('-R, --no-lr', 'disable livereload server')
  .option('-r, --lr-port <port>', 'specify the livereload port [35729]', Number, 35729)
  .parse(process.argv);


var path = resolve(program.args.shift() || '.');

var server = connect();

if(program.lr) {
  var lrserver = tinylr();
  lrserver.listen(program.lrPort);

  server.use(connectLivereload({
    port: program.lrPort
  }));

  watch(path, function(filename) {
    console.log('File', chalk.grey(filename), 'reloaded.');
    lrserver.changed({
      body: {
        files: filename
      }
    });
  });
  console.log('Livereload listening on port %s.', chalk.cyan(program.lrPort));
}

server.use(serveStatic(path));
server.listen(program.port, function() {
  console.log('Serving directory %s on port %s.', chalk.grey(path), chalk.cyan(program.port));
});
